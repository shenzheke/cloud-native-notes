# ============ INPUT ============
input {
  beats {
    port => 5044
  }
}

# ============ FILTER ============
filter {
  # 1️⃣ 提取字段（适用于 Nginx/Apache 通用访问日志）
  grok {
    match => {
      "message" => "%{COMBINEDAPACHELOG}"
    }
    overwrite => ["message"]
  }

  # 2️⃣ 时间字段标准化
  date {
    match => [ "timestamp", "dd/MMM/yyyy:HH:mm:ss Z", "ISO8601" ]
    target => "@timestamp"
    remove_field => ["timestamp"]
  }

  # 3️⃣ 解析 User-Agent
  useragent {
    source => "http_user_agent"
    target => "user_agent_parsed"
  }

  # 4️⃣ GeoIP 定位（需本地数据库）
  geoip {
    source => "clientip"
    target => "geoip"
    database => "/usr/share/GeoIP/GeoLite2-City.mmdb"
  }

  # 5️⃣ 字段清理与格式优化
  mutate {
    rename => {
      "clientip" => "client_ip"
      "bytes"    => "response_bytes"
      "verb"     => "method"
      "request"  => "url"
      "response" => "status"
    }

    convert => {
      "response_bytes" => "integer"
      "status" => "integer"
    }

    add_field => {
      "log_type" => "access_log"
      "pipeline" => "beats-logstash"
    }

    # 去除URL中的查询参数，便于聚合
    gsub => ["url", "\?.*$", ""]

    remove_field => ["ecs", "input", "host", "log", "event"]
  }
}

# ============ OUTPUT ============
output {
  elasticsearch {
    hosts => [
      "https://10.0.0.5:9200",
      "https://10.0.0.6:9200",
      "https://10.0.0.7:9200"
    ]


    user => "elastic"
    password => "p+5KfbN0KGK0eEpXRzvY"
    data_stream => true
    data_stream_auto_routing => "true"
    action => "create"   # 必须显式设置
    ssl_enabled => true
    ssl_verification_mode => full
    ssl_certificate_authorities => ["/etc/logstash/certs/elastic-cert.crt"]
  }

  # 调试模式
  # stdout { codec => rubydebug }
}

