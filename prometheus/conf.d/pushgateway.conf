# /etc/nginx/conf.d/pushgateway.conf
upstream pushgateway {
    server 127.0.0.1:9091;   # 如果 Pushgateway 在别的机器，改成对应内网 IP
    keepalive 32;
}

server {
    listen 80;
    server_name  10.0.0.41;   # 改成你自己的域名或 IP
    return 301 https://$host$request_uri;     # 强制跳转 HTTPS
}

server {
    listen 443 ssl;
    server_name  10.0.0.41;    # 同上

    # === 如果你有合法证书（Let's Encrypt 或公司签发） ===
    #$ssl_certificate     /etc/letsencrypt/live/your.domain.com/fullchain.pem;
    #ssl_certificate_key /etc/letsencrypt/live/your.domain.com/privkey.pem;

    # === 如果暂时只有自签证书，用下面这两行（测试阶段）===
     ssl_certificate     /etc/nginx/ssl/pushgateway.crt;
     ssl_certificate_key /etc/nginx/ssl/pushgateway.key;
     ssl_verify_client off;

    ssl_protocols       TLSv1.2 TLSv1.3;
    ssl_ciphers         HIGH:!aNULL:!MD5;
    ssl_session_cache   shared:SSL:10m;
    ssl_session_timeout 1d;

    # === Pushgateway 反向代理核心配置 ===
    location /pushgateway/ {
        # 去掉前缀 /pushgateway/ 转发给后端（推荐方式，避免 Pushgateway 路径错乱）
        rewrite ^/pushgateway/(.*)$ /$1 break;

        proxy_pass http://pushgateway/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # 超时调大一点，防止大批量推送卡死
        proxy_connect_timeout 30s;
        proxy_send_timeout 60s;
        proxy_read_timeout 300s;

        # Basic Auth（和 Pushgateway 自带双重保险，更安全）
        auth_basic "PushGateway Restricted";
        auth_basic_user_file /etc/pushgateway/basic-auth.htpasswd;
    }
# Prometheus 抓取专用路径（不走 basic auth，Prometheus 自己带认证）
    location = /metrics {
        proxy_pass http://pushgateway/metrics;
        proxy_set_header Host $host;
    }

    # Pushgateway 根路径也给 Prometheus 用（推荐这样写，路径最干净）
    location / {
        proxy_pass http://pushgateway/;
        proxy_set_header Host $host;
        # 这里不加 auth_basic，留给 prometheus.yml 里配 basic_auth
    }

    # 健康检查
    location /-/healthy {
        proxy_pass http://pushgateway/-/healthy;
        access_log off;
    }
}
